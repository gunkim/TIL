# 인터럽트

## 개요

하드웨어는 시스템 버스를 통해 CPU에 신호를 보내 인터럽트를 발생시킬 수 있다.

<center>
    <img src="interrupts.png">
</center>

1. CPU가 인터럽트 되면 CPU는 하던 일을 중단하고 즉시 고정된 위치로 실행을 옮긴다.
2. 이러한 고정된 위치는 일반적으로 인터럽트를 위한 서비스 루틴이 위치한 시작 주소를 가지고 있다.
3. 그리고 인터럽트 서비스 루틴이 실행된다. 
4. 인터럽트 서비스 루틴의 실행이 완료되면 CPU는 인터럽트 되었던 연산을 재개한다.

인터럽트는 빠르게 처리되어야 하며, 이를 위해 인터럽트 루틴에 대한 포인터 테이블(인터럽트 벡터)이 사용된다. 이 테이블은 인터럽트를 발생시킨 장치에 맞는 서비스 루틴(인터럽트 핸들러)을 바로 호출하게 해준다. 인터럽트가 발생하면 CPU가 원래 하던 작업의 상태가 저장되고, 인터럽트 처리 후에 원래의 상태로 복원된다. 이 과정은 인터럽트가 발생하지 않았던 것처럼 연산이 이어지도록 해준다.

## 구현

기본 인터럽트 메커니즘은 다음과 같이 작동한다. CPU 하드웨어에는 IRQ(인터럽트 요청 라인, interrupt request line)라는 선이 있다.

1. 하나의 명령어의 실행을 완료할 때마다 CPU가 I/O Unit(장치 컨트롤러)가 IRQ로 보낸 신호를 감지한다.
2. CPU가 인터럽트 번호를 읽고 이 번호를 인터럽트 벡터의 인덱스로 사용하여 ISR(Interrupt Service Routine, 인터럽트 서비스 루틴)를 찾는다.
3. ISR이 실행된다.
   1. 기존의 하던 작업을 저장
   2. 인터럽트 원인 확인
   3. 인터럽트 처리
   4. 기존 상태 복원
   5. `return_from_interrupt` 명령어를 실행하여 CPU를 인터럽트 전 실행 상태로 되돌린다.

요약하면 장치 컨트롤러가 인터럽트 요청 라인에 신호를 전송 -> 인터럽트를 발생(raise) -> CPU는 인터럽트 포착(catch) -> ISR로 디스패치(dispatch) -> ISR은 장치를 서비스 후 인터럽트 제거(clear)

위의 기본 인터럽트 기법에 더해 최신 운영체제에서는 더욱 정교한 인터럽트 처리가 필요하다.
1. 중요한 처리 중에 인터럽트 처리를 연기할 수 있어야 함
2. 장치의 적절한 ISR로 효율적인 디스패치 할 방법이 필요함
3. 우선순위가 높은 인터럽트와 우선순위가 낮은 인터럽트를 운영체제가 구분하고 적절한 긴급도로 대응할 수 있도록 다단계 인터럽트가 필요함(즉 인터럽트의 우선순위가 필요함)

최신 컴퓨터 하드웨어에서 이 세가지 기능은 CPU 및 **인터럽트 컨트롤러(Interrupt Controller) 하드웨어**에 의해 제공된다.

대부분의 CPU에는 2개의 IRQ가 있다. 
- 복구할 수 없는 메모리 오류와 같은 이벤트를 위해 예약된 **마스크 불가능 인터럽트(nonmaskable interrupt)** 이다. 
- 인터럽트 되어서는 안되는 중요한 명령 시퀀스를 실행하기 전에 CPU에 의해 꺼질 수 있기 때문에 장치 컨트롤러가 서비스를 요청하기 위해 **마스킹 가능 인터럽트(maskable interrupt)** 가 사용된다. 

